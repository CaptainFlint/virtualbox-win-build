<a href="//geektimes.ru/post/269524/"><img align="center" src="https://habrastorage.org/getpro/geektimes/post_images/122/274/f2b/122274f2b4098fd3b2d5eb703ce60fd3.png"/></a>
<br/>
<h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Введение</h4>
<br/>
Как известно большинству пользователей Windows-версии VirtualBox (далее — <em>VB</em>, не путать с Visual Basic), в релизе 4.3.14 разработчики этой программы добавили дополнительный механизм защиты, называемый «hardening» (что можно перевести как «упрочнение»), который привёл к многочисленным проблемам совместимости VB с антивирусами, драйверами крипто-модулей и даже отдельными обновлениями самой Windows, в результате чего виртуальные машины попросту отказываются запускаться. В лучшем случае пользователю приходится ждать около месяца, пока проблемная программа, о которой он сообщит разработчикам, окажется учтена в следующем релизе VB. В худшем случае придётся либо удалять конфликтующую программу (или системное обновление), либо откатывать VB до версии 4.3.12 — последней, в которой не было этой защиты. Многочисленные предложения к разработчикам о добавлении пользовательского списка исключений или опции, отключающей защиту целиком, остаются без внимания. Единственный внятный ответ с их стороны звучит так: «не хотите защиту — компилируйте из исходников сами». Что ж, придётся этим заняться.<br/>
<br/>
Несмотря на то, что процедура сборки <a href="https://www.virtualbox.org/wiki/Windows%20build%20instructions">описана</a> на официальной вики, она неполна и кое в чём устарела, а сама сборка так и норовит выдать странные ошибки. Поэтому когда я всё-таки пробился до конца сей процедуры, я решил, что её описание заслуживает отдельной статьи. Инструкция адаптирована для VB версии 5.1.4, но я сохранил инструкции и для 5.0.26 (кроме номеров строк) на случай, если кто-то пока не планирует переход на 5.1.<br/>
<br/>
<cut text="Я заинтересован" />
<h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Содержание</h4>
<blockquote>
» <a href="#task">Постановка задачи</a><br/>
» <a href="#warnings">Пара предупреждений</a><br/>
» <a href="#environment">Готовим окружение</a><br/>
» <a href="#environment-inst">Особенности установки программ</a><br/>
» <a href="#final-touches">Последние штрихи</a><br/>
» <a href="#build-vb">Собираем VirtualBox</a><br/>
» <a href="#afterword">Послесловие</a><br/>
» <a href="#history">Дополнения</a><br/>
</blockquote>
<br/>

<anchor>task</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Постановка задачи</h4><br/>
Изначально я планировал упростить себе задачу и обойтись минимальной пересборкой, чтобы устанавливать официальный дистрибутив и просто подменять в нём бинарные файлы. Однако оказалось, что такой подход не сработает, поскольку не учитывает использование системных механизмов установки и регистрации драйверов и COM-компонентов. Можно было бы попытаться разобраться в деталях и написать автоматизирующий скрипт, но я решил замахнуться на более крупную дичь: самостоятельно собрать полноценный дистрибутив, максимально близкий к официальному и отличающийся от него только отсутствием hardening'а.<br/>
<br/>
Сразу скажу, что на 100% задачу решить не удалось. Слабым звеном оказались гостевые дополнения, которые в официальном пакете собраны под Windows (32- и 64-битную), Linux, Solaris и OS/2. В комментариях соответствующего Makefile указано, что сборка осуществляется удалённо на разных машинах, а настраивать такой комплект виртуалок мне не улыбалось. В итоге я решил собирать из исходных кодов всё, кроме дополнений, ISO-образ которых буду просто скачивать с сервера Oracle. Я пока не исследовал вопрос наличия hardening'а в дополнениях, но даже если он там есть, сообщений о вызванных им проблемах мне до сих пор не попадалось.<br/>
<br/>
<anchor>warnings</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Пара предупреждений</h4><br/>
<h5>• Проблемы безопасности</h5><br/>
Про hardening известно, что добавили его не просто так, а для закрытия некой уязвимости VB. Внятно рассказать о сути уязвимости Oracle категорически отказывается, несмотря на то, что с момента фикса прошло почти полтора года. Ограничиваются лишь намёками на «очень уязвимую архитектуру Windows, разрешающую загрузку сторонних модулей в чужие процессы». Вопрос о том, как же без подобных ухищрений умудряются работать другие системы виртуализации (да и вообще все программы), также остаётся без ответа. Из отдельных скупых фраз на официальном форуме удалось выудить информацию, что проблема связана с повышением привилегий на хостовой машине, и что для этой уязвимости VB есть реально использующиеся эксплойты. Если это вас не пугает, можете продолжать чтение, но я вас предупредил.<br/>
<br/>
<h5>• Подписывание драйверов</h5><br/>
Как известно, 64-битная Windows в обычном режиме запрещает загрузку драйверов, не подписанных сертификатом с цепочкой доверия, ведущей до корневого сертификата Microsoft (а в Windows 10 предпринимаются шаги к запрету вообще всех драйверов, подписанных не в Microsoft). Поэтому прежде чем компилировать VB даже для личного использования, необходимо продумать решение этой проблемы: либо купить сертификат, либо попробовать воспользоваться сервисами подписывания драйверов для разработчиков Open Source (если они, конечно, согласятся подписать заведомо уязвимый драйвер), либо перевести свою Windows в тестовый режим и использовать самоподписанный тестовый сертификат.<br/>
<br/>
Далее я буду ориентироваться на этот последний вариант, но в нужных местах укажу, как поменяется процедура при наличии полноценного сертификата.<br/>
<br/>
<anchor>environment</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Готовим окружение</h4><br/>
Официально в качестве сборочной системы рекомендуется Windows версии от XP SP3 до 7. Всю работу я проводил в Windows 7 SP1 x64, но, думаю, что с более современными версиями проблем возникнуть не должно. Если вы выделяете для сборки отдельную машину (реальную или виртуальную), имейте в виду, что ей необходим доступ в Интернет.<br/>
<br/>
Для создания сборочного окружения потребуется немаленький набор программ. Если для программы присутствует портабельная версия, я использую её, а не инсталлятор.<br/>
<br/>
Следующий набор программ поставляется только в виде инсталляторов (по крайней мере, официально). Для Visual Studio и SDK/WDK важно соблюдать порядок установки, как указано ниже. После установки крайне желательно установить обновления через Windows Update с включённой опцией поддержки всех продуктов Microsoft.<br/>
<ul>
<li><b>Visual Studio 2010 Professional</b><br/>Для полноценной сборки требуется именно 2010, и именно Professional. В версии 2010 Express нет библиотеки ATL, необходимой для сборки COM API, через который работают фронт-энды. Я сделал несколько попыток перенести проект на VS 2013 или 2015 Community Edition, чтобы избавиться от необходимости платной лицензии, но, увы, безуспешно.</li>
<li><b><a href="http://www.microsoft.com/en-us/download/details.aspx?id=8279">Windows SDK v7.1</a></b></li>
<li><b><a href="https://www.microsoft.com/en-US/download/details.aspx?id=23691">Visual Studio 2010 SP1</a></b></li>
<li><b><a href="https://www.microsoft.com/en-us/download/details.aspx?id=4422">Visual C++ 2010 SP1 Compiler Update for SDK 7.1</a></b></li>
<li><b><a href="http://www.microsoft.com/en-us/download/details.aspx?displaylang=en&id=11800">Windows Driver Development Kit (WDK) v7.1</a></b></li>
<li><b><a href="https://dev.windows.com/downloads/windows-8-1-sdk">Windows SDK v8.1</a></b></li>
<li><b><a href="http://www.activestate.com/activeperl/downloads">ActivePerl</a></b></li>
<li><b><a href="http://www.activestate.com/activepython/downloads">ActivePython 2.7</a></b></li>
<li><b><a href="http://wixtoolset.org/">WiX</a></b></li>
</ul>
<br/>
Остальные программы скачиваются в виде архивов или исходных кодов:<br/>
<ul>
<li>Для VB 5.0.x: <b><a href="http://download.qt.io/official_releases/qt/4.8/4.8.7/qt-everywhere-opensource-src-4.8.7.zip">Qt 4.8.7</a></b>, для VB 5.1.x: <b><a href="http://download.qt.io/official_releases/qt/5.6/5.6.1-1/single/qt-everywhere-opensource-src-5.6.1-1.zip">Qt 5.6.1</a></b> (исходные коды)</li>
<li><b>MinGW 3.3.3</b> (32-битная версия):
  <ul>
    <li><b><a href="http://prdownloads.sf.net/mingw/gcc-core-3.3.3-20040217-1.tar.gz?download">MinGW GCC</a></b></li>
    <li><b><a href="http://prdownloads.sf.net/mingw/gcc-g++-3.3.3-20040217-1.tar.gz?download">GCC-C++</a></b></li>
    <li><b><a href="http://prdownloads.sf.net/mingw/mingw-runtime-3.8.tar.gz?download">Runtime</a></b></li>
    <li><b><a href="http://prdownloads.sf.net/mingw/w32api-3.5.tar.gz?download">W32API</a></b></li>
    <li><b><a href="http://prdownloads.sf.net/mingw/binutils-2.13.90-20021006-2.tar.gz?download">Binutils</a></b></li>
  </ul>
</li>
<li><b>MinGW-w64 4.5.4</b> (64-битная версия):
  <ul>
    <li><b><a href="http://sourceforge.net/projects/mingw-w64/files/Toolchains%20targetting%20Win64/Personal%20Builds/rubenvb/gcc-4.5-release/x86_64-w64-mingw32-gcc-4.5.4-release-win64_rubenvb.7z/download">GCC</a></b></li>
  </ul>
</li>
<li><b><a href="http://www.libsdl.org/download-1.2.php">SDL v1.2.x</a></b> (development-пакет для Visual C++)</li>
<li><b><a href="http://curl.haxx.se/download.html">cURL</a></b> (исходные коды)</li>
<li><b><a href="http://www.openssl.org/source/">OpenSSL 1.0.2</a></b> (исходные коды)</li>
<li><b><a href="http://sourceforge.net/projects/gsoap2/files/gSOAP/">gSOAP 2.7.x</a></b></li>
<li><b><a href="http://miktex.org/portable">MiKTeX Portable</a></b></li>
<li><b><a href="http://gnuwin32.sourceforge.net/packages/wget.htm">wget</a></b><br/>Требуются два архива: Binaries и Dependencies.</li>
<li><b><a href="http://www.nasm.us/">NASM</a></b><br/>Рекомендую 64-битную портативную версию.</li>
</ul>
<br/>
<spoiler title="Зачем оно всё?">
Если вы не планируете собирать такой же пакет, как я, то некоторые из перечисленных инструментов могут вам не потребоваться. Здесь я вкратце перечислю, какую роль они выполняют.<br/>
<br/>
<ul>
<li>SDK 8.1<br/>
Для сборки будет использоваться SDK версии 7.1, версия 8.1 требуется только для утилиты SignTool: в 7.1 отсутствует поддержка двойного подписывания SHA-1/SHA-256. Если у вас есть компьютер с установленным SDK версии 8.1 или более поздней, можно просто скопировать утилиту signtool.exe оттуда (со всеми зависимостями) и указать соответствующий путь в файле <code>LocalConfig.kmk</code> (см. ниже).
</li>
<li>WiX<br/>
Это инструмент для создания MSI-инсталляторов. Хоть финальный вариант инсталлятора и является EXE-файлом, внутри он содержит два MSI, так что WiX тут необходим. Если вам достаточно простой компиляции бинарников, то этот пакет не понадобится.
</li>
<li>SDL<br/>
На этой библиотеке основан фронт-энд <code>VBoxSDL.exe</code> — минималистичная альтернатива стандартной оболочке <code>VirtualBox.exe</code>. Если вам не требуется VBoxSDL, то, может быть, удастся обойтись без библиотеки SDL, но я это не проверял.
</li>
<li>gSOAP<br/>
Этот компонент необходим для сборки сервиса удалённого управления VB: <code>VBoxWebSrv.exe</code>. Отсутствие gSOAP не является критической ошибкой, VB успешно соберётся без этого сервиса.
</li>
<li>MiKTeX<br/>
При помощи MiKTeX компилируется справочник в формате PDF (<code>doc\UserManual.pdf</code>). Отсутствие MiKTeX не является критической ошибкой, VB успешно соберётся без PDF-документации.
</li>
<li>wget<br/>
wget или его альтернатива будет использоваться для скачивания ISO-образа гостевых дополнений. Этих команд изначально нет в проекте VB, они добавляются вручную в kmk-файл (см. ниже). Если вам не нужны гостевые дополнения в дистрибутиве, можно обойтись без wget, но тогда нужно будет учесть это при модификации сборочных правил. Альтернативой может работать cURL, исходники которого уже участвуют в процессе сборки. Но в текущем варианте сам curl.exe не собирается, только библиотека libcurl, так что для использования curl потребуется сначала его самостоятельно собрать (или скачать уже скомпилированный кем-то вариант).
</li>
<li>NASM<br/>
Этот ассемблер будет использоваться для сборки OpenSSL. Поддерживается и сборка без внешнего ассемблера, но с ним будет создан более оптимальный код.
</li>
</ul>
</spoiler>
<br/>
Чтобы легче было отслеживать потенциальные источники проблем сборки, привожу здесь сводную таблицу всех инструментов с их версиями и путями установки в созданном мной окружении. Обозначение «<code>{x32|x64}</code>» указывает, что пакет устанавливается в два разных каталога для 32- и 64-битной версии.
<table>
<tr><th>Программа</th><th>Версия</th><th>Путь установки</th></tr>
<tr><td>Visual Studio</td><td>2010 Professional</td><td><code>C:\Program Files (x86)\Microsoft Visual Studio 10.0\</code></td></tr>
<tr><td>SDK</td><td>7.1</td><td><code>C:\Program Files\Microsoft SDKs\Windows\v7.1\</code></td></tr>
<tr><td>SDK</td><td>8.1</td><td><code>C:\Programs\DevKits\8.1\</code></td></tr>
<tr><td>WDK</td><td>7.1.0</td><td><code>C:\WinDDK\7600.16385.1\</code></td></tr>
<tr><td>ActivePerl</td><td>5.24.0 Build 2400 x64</td><td><code>C:\Programs\Perl\</code></td></tr>
<tr><td>ActivePython</td><td>2.7.10.12 x64</td><td><code>C:\Programs\Python\</code></td></tr>
<tr><td>WiX</td><td>3.10.3.3007</td><td><code>C:\Program Files (x86)\WiX Toolset v3.10\</code></td></tr>
<tr><td>Qt4</td><td>4.8.7</td><td><code>C:\Programs\Qt\4.8.7-{x32|x64}\</code></td></tr>
<tr><td>Qt5</td><td>5.6.1</td><td><code>C:\Programs\Qt\5.6.1-{x32|x64}\</code></td></tr>
<tr><td>MinGW</td><td>3.3.3-20040217-1</td><td><code>C:\Programs\mingw32\</code></td></tr>
<tr><td>MinGW Runtime</td><td>3.8</td><td><code>C:\Programs\mingw32\</code></td></tr>
<tr><td>MinGW W32API</td><td>3.5</td><td><code>C:\Programs\mingw32\</code></td></tr>
<tr><td>MinGW Binutils</td><td>2.13.90-20021006-2</td><td><code>C:\Programs\mingw32\</code></td></tr>
<tr><td>MinGW-w64</td><td>4.5.4</td><td><code>C:\Programs\mingw64\</code></td></tr>
<tr><td>SDL</td><td>1.2.15</td><td><code>C:\Programs\SDL\{x32|x64}\</code></td></tr>
<tr><td>cURL</td><td>7.50.1</td><td><code>C:\Programs\curl\{x32|x64}\</code></td></tr>
<tr><td>OpenSSL</td><td>1.0.2h</td><td><code>C:\Programs\OpenSSL\{x32|x64}\</code></td></tr>
<tr><td>gSOAP</td><td>2.7.16</td><td><code>C:\Programs\gSOAP\</code></td></tr>
<tr><td>MiKTeX Portable</td><td>2.9.5719</td><td><code>C:\Programs\MiKTeX\</code></td></tr>
<tr><td>wget</td><td>1.11.4.1</td><td><code>C:\Programs\wget\</code></td></tr>
<tr><td>NASM</td><td>2.12.02 x64</td><td><code>C:\Programs\nasm\</code></td></tr>
</table>

<anchor>environment-inst</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Особенности установки программ</h4><br/>
В этом разделе я привожу указания или инструкции для отдельных пакетов, где процедура неочевидна или требует дополнительных шагов.<br/>
<br/>
<h5>• Windows SDK v7.1</h5>
При установке могут возникнуть проблемы из-за устаревших версий компиляторов и рантайма: они не могут установиться поверх более новых версий, установленных с VS 2010, и инсталлятор считает это критической ошибкой. Необходимо либо отключить соответствующие галочки, либо предварительно удалить из системы пакеты с именами вида <i>«Microsoft Visual C++ 2010 &lt;arch&gt; Redistributable»</i>, <i>«Microsoft Visual C++ 2010 &lt;arch&gt; Runtime»</i>, <i>«Microsoft Visual C++ Compilers…»</i> (SDK установит старые версии пакетов, а Windows Update потом обновит их до актуальных).<br/>
<br/>
Также обратите внимание, что для финальной сборки MSI-пакетов потребуется установить примеры программ (Windows Native Code Development -&gt; Samples): в их составе идут скрипты, использующиеся сборочными правилами.<br/>
<br/>
<h5>• Windows SDK v8.1</h5>
Достаточно установить только средства разработки (Windows Software Development Kit).<br/>
<br/>
<h5>• WDK v7.1</h5>
Достаточно установить только сборочные окружения (Build Environments).<br/>
<br/>
<h5>• Qt 4.8.7</h5>
Эта версия Qt нужна для версий VB 5.0.x и ниже. Поскольку официальных сборок Qt для 64-битной Windows нет, то собирать её придётся вручную. Также я рекомендую собрать из исходников и 32-битную версию: для удобства и единства интерфейса.<br/>
<br/>
<ol>
<li>Распаковываем архив с исходным кодом Qt в каталог <code>C:\Programs\Qt\</code> и переименовываем полученный подкаталог <code>qt-everywhere-opensource-src-4.8.7</code> в <code>4.8.7-src</code> (для красоты и краткости).</li>
<li>Рядом создаём два каталога: <code>build-x32</code> (в нём будет происходить сборка) и <code>4.8.7-x32</code> (сюда будут установлены итоговые бинарники).</li>
<li>Копируем подкаталог <code>4.8.7-src\mkspecs</code> со всем содержимым в <code>4.8.7-x32\</code>.</li>
<li>
Открываем консоль, выполняем следующие команды:
<source lang=".bat">cd /d C:\Programs\Qt\build-x32
SET QTVER=4.8.7
"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7
COLOR 07
SET QTDIR=C:\Programs\Qt\%QTVER%-x32
SET PATH=%QTDIR%\bin;%PATH%
SET QMAKESPEC=win32-msvc2010</source>
Команда <code>color</code> отключает зелёный цвет шрифта, устанавливаемый скриптом <code>SetEnv.Cmd</code>.
</li>
<li>
Теперь запускаем <code>configure.exe</code> из каталога <code>4.8.7-src</code>. Можно конфигурировать по умолчанию, но я предпочитаю бо́льшую часть опций указывать явным образом, а ненужные модули отключать совсем, чтобы ускорить компиляцию. Вот команда, которую я использовал у себя:
<source lang=".bat">..\4.8.7-src\configure.exe -prefix C:\Programs\Qt\4.8.7-x32 -opensource -confirm-license -release -shared -no-ltcg -no-fast -exceptions -no-dsp -accessibility -stl -no-sql-sqlite -no-qt3support -opengl desktop -no-nis -no-inotify -largefile -little-endian -no-fontconfig -no-system-proxies -graphicssystem raster -qt-zlib -qt-libpng -qt-libmng -qt-libtiff -qt-libjpeg -no-openssl -no-dbus -no-phonon -no-phonon-backend -no-multimedia -no-audio-backend -no-webkit -no-script -no-scripttools -no-declarative -no-declarative-debug -no-directwrite -no-style-plastique -no-style-motif -no-style-cde -no-style-windowsce -no-style-windowsmobile -no-style-s60 -native-gestures -mp -nomake examples -nomake demos -nomake tests</source>
</li>
<li>Когда программа отработает, запускаем сборку командой <code>nmake</code></li>
<li>Ну и, наконец, устанавливаем скомпилированную библиотеку командой <code>nmake install</code></li>
</ol>
<br/>
Теперь открываем новую консоль и аналогичным образом компилируем и устанавливаем 64-битную версию, только в именах каталогов необходимо заменить «x32» на «x64», а команды создания окружения будут выглядеть так:
<source lang=".bat">cd /d C:\Programs\Qt\build-x64
SET QTVER=4.8.7
"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7
COLOR 07
SET QTDIR=C:\Programs\Qt\%QTVER%-x64
SET PATH=%QTDIR%\bin;%PATH%
SET QMAKESPEC=win32-msvc2010</source>
<br/>
После установки обеих версий Qt можно удалять каталоги <code>build-x32</code>, <code>build-x64</code> и <code>4.8.7-src</code>, чтобы не занимали место: они нам больше не понадобятся.<br/>
<br/>
<h5>• Qt 5.6.1</h5>
В версии VB 5.1.0 разработчики перешли на Qt5. Судя по коду, Qt4 по-прежнему поддерживается, но я не проверял. Начиная с версии Qt 5.7.0 прекращена поддержка сборки в MSVC версий ниже 2012, поэтому используем 5.6.x.<br/>
Для Visual Studio 2010 официальные сборки отсутствуют, поэтому, как и для 4.8.7, необходимо сначала собрать библиотеку из исходных кодов.<br/>
<br/>
<ol>
<li>Распаковываем архив с исходным кодом Qt в каталог <code>C:\Programs\Qt\</code> и переименовываем полученный подкаталог <code>qt-everywhere-opensource-src-5.6.1</code> в <code>5.6.1-src</code>.</li>
<li>Рядом создаём каталог <code>build-x32</code>, в котором будет происходить сборка.</li>
<li>
Открываем консоль, выполняем следующие команды:
<source lang=".bat">cd /d C:\Programs\Qt\build-x32
SET QTVER=5.6.1
"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7
COLOR 07
SET QTDIR=C:\Programs\Qt\%QTVER%-x32
SET PATH=%QTDIR%\bin;%PATH%
SET QMAKESPEC=win32-msvc2010</source>
Цвет шрифта можно сбросить командой <code>color</code> без параметров.
</li>
<li>
Теперь запускаем <code>configure.bat</code> из каталога <code>5.6.1-src</code>. Поскольку бо́льшая часть Qt в VB не используется, можно сильно ускорить сборку, отключив ненужные компоненты, но необходимо учитывать, что к некоторым опциям VB относится очень щепетильно. В частности, я наткнулся на следующее:
<ul>
<li>OpenGL ES 2 не поддерживается (компиляция VB не может увидеть некоторые заголовочные файлы).</li>
<li>Поддержка FreeType должна быть включена (без неё не соберётся плагин qoffscreen, использующийся в VB).</li>
</ul>
Вот итоговая команда, которую я использовал у себя:
<source lang=".bat">..\5.6.1-src\configure.bat -prefix c:\Programs\Qt\5.6.1-x32 -mp -opensource -confirm-license -nomake tests -nomake examples -no-compile-examples -release -shared -pch -no-ltcg -accessibility -no-sql-sqlite -opengl desktop -no-openvg -no-nis -no-iconv -no-evdev -no-mtdev -no-inotify -no-eventfd -largefile -no-system-proxies -qt-zlib -qt-pcre -no-icu -qt-libpng -qt-libjpeg -qt-freetype -no-fontconfig -qt-harfbuzz -no-angle -incredibuild-xge -no-plugin-manifests -qmake -qreal double -rtti -strip -no-ssl -no-openssl -no-libproxy -no-dbus -no-audio-backend -no-wmf-backend -no-qml-debug -no-direct2d -directwrite -no-style-fusion -native-gestures -skip qt3d -skip qtactiveqt -skip qtandroidextras -skip qtcanvas3d -skip qtconnectivity -skip qtdeclarative -skip qtdoc -skip qtenginio -skip qtgraphicaleffects -skip qtlocation -skip qtmacextras -skip qtmultimedia -skip qtquickcontrols -skip qtquickcontrols2 -skip qtscript -skip qtsensors -skip qtserialbus -skip qtserialport -skip qtwayland -skip qtwebchannel -skip qtwebengine -skip qtwebsockets -skip qtwebview -skip qtx11extras -skip qtxmlpatterns</source>
</li>
<li>Далее запускаем сборку командой <code>nmake</code></li>
<li>Устанавливаем скомпилированную библиотеку командой <code>nmake install</code></li>
</ol>
<br/>
Теперь открываем новую консоль и аналогичным образом компилируем и устанавливаем 64-битную версию, только в именах каталогов необходимо заменить «x32» на «x64», а команды создания окружения будут выглядеть так:
<source lang=".bat">cd /d C:\Programs\Qt\build-x64
SET QTVER=5.6.1
"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7
COLOR 07
SET QTDIR=C:\Programs\Qt\%QTVER%-x64
SET PATH=%QTDIR%\bin;%PATH%
SET QMAKESPEC=win32-msvc2010</source>
<br/>
После завершения установки каталоги <code>build-x32</code>, <code>build-x64</code> и <code>5.6.1-src</code> можно удалять.<br/>
<br/>
<h5>• MinGW</h5>
Для установки 32-битной MinGW просто последовательно распакуйте все пять архивов в целевой каталог. Совпадающие файлы перезаписываются.<br/>
<br/>
MinGW-w64 состоит из одного архива и распаковывается в отдельный каталог.<br/>
<br/>
<h5>• SDL</h5>
<ol>
<li>Распаковываем SDL два раза в отдельные каталоги: <code>C:\Programs\SDL\x32\</code> и <code>C:\Programs\SDL\x64\</code>.</li>
<li>Перемещаем всё содержимое <code>C:\Programs\SDL\x64\lib\x64\</code> на уровень выше (в <code>C:\Programs\SDL\x64\lib\</code>), каталоги <code>C:\Programs\SDL\x64\lib\x86</code> и <code>x64</code> удаляем.</li>
<li>Аналогично для 32-битной версии: перемещаем содержимое <code>C:\Programs\SDL\x32\lib\x86\</code> на уровень выше, каталоги <code>C:\Programs\SDL\x32\lib\x86</code> и <code>x64</code> удаляем.</li>
</ol>
<br/>
<h5>• OpenSSL</h5>
<ol>
<li>Распаковываем архив OpenSSL два раза в каталог <code>C:\Programs\OpenSSL\</code>, переименовывая полученный подкаталог из <code>openssl-1.0.2h</code>, соответственно, в <code>openssl-1.0.2h-x32</code> и <code>openssl-1.0.2h-x64</code>.</li>
<li>Открываем консоль, собираем и устанавливаем 32-битную версию:
<source lang=".bat">"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7
COLOR 07
set PATH=%PATH%;C:\Programs\nasm
cd /d C:\Programs\OpenSSL\openssl-1.0.2h-x32\
perl Configure VC-WIN32 --prefix=C:\Programs\OpenSSL\x32
ms\do_nasm
nmake -f ms\ntdll.mak
nmake -f ms\ntdll.mak install</source>
Если вы не хотите использовать NASM, исключите из инструкции выше модификацию переменной <code>PATH</code>, добавьте к вызову <code>Configure</code> параметр <code>no-asm</code>, а вместо скрипта <code>ms\do_nasm</code> запускайте <code>ms\do_ms</code>.
</li>
<li>
Открываем новую консоль, собираем и устанавливаем 64-битную версию:
<source lang=".bat">"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7
COLOR 07
set PATH=%PATH%;C:\Programs\nasm
cd /d C:\Programs\OpenSSL\openssl-1.0.2h-x64\
perl Configure VC-WIN64A --prefix=C:\Programs\OpenSSL\x64
ms\do_win64a
nmake -f ms\ntdll.mak
nmake -f ms\ntdll.mak install</source>
64-битная сборка автоматически определяет наличие NASM. Если у вас его нет, просто оставьте переменную <code>PATH</code> без изменений.
</li>
<li>Каталоги <code>C:\Programs\OpenSSL\openssl-1.0.2h-x32</code> и <code>openssl-1.0.2h-x64</code> можно удалять.</li>
</ol>
<br/>
<h5>• cURL</h5>
<ol>
<li>Распаковываем архив cURL в каталог: <code>C:\Programs\curl\</code>, переименовываем получившийся подкаталог из <code>curl-7.50.1</code> в <code>curl-7.50.1-x32</code>.</li>
<li>
Открываем в редакторе файл <code>C:\Programs\curl\curl-7.50.1-x32\lib\Makefile.vc10</code>, находим там в районе строки 122 следующий код:
<source>CFLAGS       = $(CFLAGS)</source>
и заменяем на:
<source>CFLAGS       = $(CFLAGS) /DCURL_DISABLE_LDAP</source>
Если этого не сделать, то при сборке VB полезут ошибки линковки.
</li>
<li>Делаем копию каталога <code>curl-7.50.1-x32</code> под именем <code>curl-7.50.1-x64</code>.</li>
<li>Открываем консоль, собираем 32-битную версию библиотеки (сам curl не потребуется) и копируем необходимые файлы в целевой каталог:
<source lang=".bat">"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7
COLOR 07
cd /d C:\Programs\curl\curl-7.50.1-x32\lib
md C:\Programs\curl\x32
set INCLUDE=c:\Programs\OpenSSL\x32\include;%INCLUDE%
set LIB=C:\Programs\OpenSSL\x32\lib;%LIB%
set LIBPATH=C:\Programs\OpenSSL\x32\lib;%LIBPATH%
nmake /f Makefile.vc10 cfg=release-ssl
copy *.lib ..\..\x32
xcopy /E ..\include\curl ..\..\x32\include\curl\</source>
</li>
<li>
Собираем 64-битную версию, открыв новую консоль и выполнив команды:
<source lang=".bat">"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7
COLOR 07
cd /d C:\Programs\curl\curl-7.50.1-x64\lib
md C:\Programs\curl\x64
set INCLUDE=c:\Programs\OpenSSL\x64\include;%INCLUDE%
set LIB=C:\Programs\OpenSSL\x64\lib;%LIB%
set LIBPATH=C:\Programs\OpenSSL\x64\lib;%LIBPATH%
nmake /f Makefile.vc10 MACHINE=x64 cfg=release-ssl
copy *.lib ..\..\x64
xcopy /E ..\include\curl ..\..\x64\include\curl\</source>
</li>
<li>Каталоги <code>C:\Programs\curl\curl-7.50.1-x32</code> и <code>curl-7.50.1-x64</code> можно удалять.</li>
</ol>
<br/>
<h5>• gSOAP</h5>
<ol>
<li>Открываем архив, заходим в подкаталог <code>gsoap-2.7\gsoap</code> и распаковываем содержимое этого подкаталога в <code>C:\Programs\gSOAP\</code>.</li>
<li>
Открываем на редактирование файл <code>C:\Programs\gSOAP\stdsoap2.cpp</code>, ищем там следующий код (строка 4001):
<source lang="cpp">            { X509V3_EXT_METHOD *meth = X509V3_EXT_get(ext);</source>
и добавляем к определению переменной const, чтобы получилось так:
<source lang="cpp">            { const X509V3_EXT_METHOD *meth = X509V3_EXT_get(ext);</source>
<code>X509V3_EXT_get()</code> — это функция из OpenSSL, она возвращает константный указатель, так что без этой правки сборка завершится ошибкой приведения типа.
</li>
</ol>
<br/>
<h5>• MiKTeX</h5>
<ol>
<li>Распаковываем архив в <code>C:\Programs\MiKTeX\</code></li>
<li>
Открываем консоль и запускаем установку дополнительных модулей:
<source lang=".bat">"C:\Programs\MiKTeX\miktex\bin\mpm.exe" --verbose --install=koma-script --install=ucs --install=tabulary --install=url --install=fancybox --install=fancyvrb --install=bera --install=charter --install=mptopdf</source>
</li>
</ol>
<br/>
<h5>• wget</h5>
Просто распаковываем архивы <code>wget-1.11.4-1-bin.zip</code> и <code>wget-1.11.4-1-dep.zip</code> в <code>C:\Programs\wget\</code><br/>
<br/>

<anchor>final-touches</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Последние штрихи</h4>
<br/>
Подготовка к сборке почти завершена, остались несколько шагов. Если вы этого ещё не сделали, нужно скачать архив с исходными кодами VirtualBox нужной версии и распаковать его в удобное место. В качестве рабочего каталога я выбрал <code>C:\Devel\</code>; в него я распаковал архив исходных кодов и переименовал полученный каталог в <code>VirtualBox-src</code>.<br/>
<br/>
<h5>• Добавление сертификатов</h5>
Если у вас нет полноценного сертификата, то рекомендуется создать хотя бы персональный (с ним проще загружать драйверы, чем совсем без подписи). Для этого нужно открыть консоль с повышенными привилегиями и выполнить в ней следующие команды:
<source lang=".bat">"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7
COLOR 07
makecert.exe -a sha1 -r -pe -ss my -n "CN=Roga and Kopyta Ltd" C:\Devel\testcert_1.cer
makecert.exe -a sha256 -r -pe -ss my -n "CN=Roga and Kopyta Ltd" C:\Devel\testcert_256.cer
certmgr.exe -add C:\Devel\testcert_1.cer -s -r localMachine root
certmgr.exe -add C:\Devel\testcert_256.cer -s -r localMachine root</source>
Имя для сертификатов («Roga and Kopyta Ltd») и путь к файлам можно выбирать по своему усмотрению. Поскольку имена одинаковые, для различения сертификатов нужно будет использовать цифровой отпечаток. Откройте консоль управления сертификатами (запустите <code>certmgr.msc</code>), откройте там список персональных сертификатов. Дважды щёлкните на первом из сертификатов «Roga and Kopyta Ltd», в открывшемся диалоге перейдите на вкладку Details. В поле Signature algorithm будет указан алгоритм подписи: sha256RSA или sha1RSA. Далее, в самом конце списка будет поле Thumbprint со значением в виде последовательности шестнадцатеричных чисел. Скопируйте это значение куда-нибудь. То же самое повторите для второго из сертификатов. Не забудьте отметить, какой из них был sha256, а какой — sha1. (Более простым решением было бы задать разные имена сертификатам, но две разноимённых подписи будут смотреться неэстетично.)<br/>
<br/>
<h5>• Сборка xmllint</h5>
На одном из этапов потребуется также программа xmllint. Я не указывал её в списке требований, потому что необходимые исходники уже присутствуют в архиве VB. Сборочные правила не рассчитаны на автоматическую сборку этой утилиты, поэтому её придётся собрать отдельно. В качестве целевого каталога я выбрал <code>C:\Programs\xmllint</code>.
<ol>
<li>Копируем содержимое каталога <code>C:\Devel\VirtualBox-src\src\libs\libxml2-2.9.2</code> в <code>C:\Programs\libxml2-2.9.2\</code> (это необходимо, чтобы промежуточные объектные файлы не мешали сборке самого VB).</li>
<li>Открываем консоль и выполняем команды:
<source lang=".bat">"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7
COLOR 07
cd /d C:\Programs\libxml2-2.9.2\win32
cscript.exe configure.js cruntime=/MT prefix=C:\Programs\xmllint iconv=no
nmake /f Makefile.msvc
nmake /f Makefile.msvc install</source>
</li>
<li>Удаляем каталог <code>C:\Programs\libxml2-2.9.2</code>.</li>
</ol>
<br/>
<h5>• Различные правки VB</h5>
Прежде чем приступать к сборке, нам ещё потребуется внести кое-какие правки в исходные коды самого VirtualBox. Так что переходим в каталог <code>C:\Devel\VirtualBox-src</code> и начинаем:
<ol>
<li>
Открываем файл <code>configure.vbs</code>, находим код (строка 1062):
<source lang="vbscript">if Shell(DosSlashes(strPathVC & "/bin/cl.exe"), True) <> 0 then</source>
и заменяем на следующий:
<source lang="vbscript">if Shell(DosSlashes(strPathVC & "/bin/cl.exe") & " /?", True) <> 0 then</source>
Этот кусок отвечает за поиск и проверку компилятора, но не учитывает, что вызов <code>cl.exe</code> без аргументов возвращает ошибку (что трактуется как неподходящий компилятор). Добавление параметра «<code>/?</code>» запрашивает вывод справки, и код возврата перестаёт быть ошибочным.<br/>
Далее в этом же файле находим функцию <code>CheckForCurlSub</code> и удаляем в ней проверку наличия <code>libcurl.dll</code> (строка 2014):
<source lang="vbscript">    And LogFindFile(strPathCurl, "libcurl.dll") <> "" _</source>
Сборка VB использует статическую линковку с libcurl, поэтому DLL ему не нужна (и мы её не собирали). Но по какой-то причине он проверяет её присутствие. Вместо удаления кода можно просто собрать DLL-вариант библиотеки или создать пустой файл с таким именем, это уже на ваш вкус.
</li>
<li>
Открываем файл <code>Makefile.kmk</code> и где-нибудь за пределами условных блоков добавляем следующий код (я добавил в строке 142, перед комментарием «Install our Qt DLLs…»):
<source># OpenSSL DLLs
ifeq ($(KBUILD_TARGET),win)
 SDK_VBOX_OPENSSL_DLLS ?= $(subst .lib,.dll,$(subst /lib/,/bin/,$(SDK_VBOX_OPENSSL_LIBS)))
 InstallExternalLibs_SOURCES += \
 	$(foreach sslmod,$(SDK_VBOX_OPENSSL_DLLS),$(call VBOX_RE_SIGN_DLL_FN,InstallExternalLibs,$(sslmod)))
endif</source>
При сборке VB производится копирование библиотек-зависимостей (таких как Qt, SDL) в целевой каталог. OpenSSL, видимо, в Oracle компилируется статически, а у нас он — динамический, поэтому здесь мы добавили копирование и подписывание соответствующих библиотек. (Я пробовал также собирать OpenSSL статически, но подход «в лоб» не сработал, полезли конфликты на стадии линковки.)
</li>
<li>
Открываем файл <code>src\recompiler\Makefile.kmk</code>, в строке 123 находим следующий код:
<source>VBoxRemPrimary_SOURCES.win = $(VBoxREMImp_0_OUTDIR)/VBoxREMRes.o</source>
и заменяем на:
<source>VBoxRemPrimary_SOURCES.win =
VBoxRemPrimary_SOURCES.win.amd64 = $(VBoxREMImp_0_OUTDIR)/VBoxREMRes.o</source>
Здесь используется MinGW, а при сборке 32-битной версии VB, как вы помните, у нас работает MinGW 3.3.3. Её компилятор ресурсов неправильно трактует переданные ему параметры, так что сборка падает. Этой заменой я отключаю использование (а следовательно, и компиляцию) ресурсного объектника для 32-битной версии. На работоспособность итоговых файлов это не влияет.
</li>
<li>
Открываем файл <code>src\VBox\Installer\win\VBoxMergeApp.wxi</code> и добавляем инструкции по упаковке OpenSSL-библиотек в дистрибутив. Этот код можно вставить в любое место за пределами условных блоков (я добавил в строку 361, перед комментарием «EFI firmware»):
<source lang="xml">        &lt;!-- OpenSSL DLL files --&gt;
        &lt;File Id="file_ssleay32.dll" Name="ssleay32.dll"
              Source="$(env.PATH_OUT)\bin\ssleay32.dll" /&gt;
        &lt;File Id="file_libeay32.dll" Name="libeay32.dll"
              Source="$(env.PATH_OUT)\bin\libeay32.dll" /&gt;</source>
</li>
<li>
Следующая правка актуальна только для версий 5.0.x. В том же файле в строке 281 находим следующий код:
<source lang="xml">        &lt;File Id="file_QtCoreVBox4.dll" Name="QtCoreVBox4.dll"
              Source="$(env.PATH_OUT)\bin\QtCoreVBox4.dll" /&gt;
        &lt;File Id="file_QtGuiVBox4.dll" Name="QtGuiVBox4.dll"
              Source="$(env.PATH_OUT)\bin\QtGuiVBox4.dll" /&gt;</source>
и удаляем из имён файлов подстроку «VBox», чтобы получилось:
<source lang="xml">        &lt;File Id="file_QtCore4.dll" Name="QtCore4.dll"
              Source="$(env.PATH_OUT)\bin\QtCore4.dll" /&gt;
        &lt;File Id="file_QtGui4.dll" Name="QtGui4.dll"
              Source="$(env.PATH_OUT)\bin\QtGui4.dll" /&gt;</source>
Чуть ниже делаем аналогичную замену:
<source lang="xml">        &lt;File Id="file_QtOpenGLVBox4.dll" Name="QtOpenGLVBox4.dll"
              Source="$(env.PATH_OUT)\bin\QtOpenGLVBox4.dll" /&gt;</source>
на:
<source lang="xml">        &lt;File Id="file_QtOpenGL4.dll" Name="QtOpenGL4.dll"
              Source="$(env.PATH_OUT)\bin\QtOpenGL4.dll" /&gt;</source>
Библиотека Qt для оригинального VB собирается с брэндированным суффиксом, так что итоговые библиотеки имеют имена вида <code>QtCoreVBox4.dll</code>. Мы же собирали библиотеку без таких суффиксов, так что если не выполнить замену, компилятор не найдёт файлы. В VB 5.1.x разработчики вынесли суффикс «VBox» в отдельную переменную, так что там эта замена не нужна.<br/>
</li>
<li>Открываем файл <code>doc\manual\Makefile.kmk</code> и удаляем оттуда все подстроки вида «<code> --nonet</code>». Этот аргумент у утилит обработки XML-файлов запрещает автоматическое скачивание DTD-схем, поэтому для успешной обработки требуется либо самостоятельно скачать все шаблоны, разместить их на локальном диске и прописать пути к ним в специальных переменных, либо отказаться от этого запрета, удалив параметр. Я пошёл по второму пути.</li>
<li>
Открываем файл <code>src\VBox\Additions\Makefile.kmk</code>, находим там правило для сборки ISO-образа гостевых дополнений (строки 276-313), начинающееся с объявления:
<source>$(VBOX_PATH_ADDITIONS_ISO)/VBoxGuestAdditions.iso: \</source>
Удаляем весь этот блок, вместо него вставляем единственную команду для загрузки официального образа:
<source>$(VBOX_PATH_ADDITIONS_ISO)/VBoxGuestAdditions.iso:
	$(TOOL_WGET_FETCH) http://download.virtualbox.org/virtualbox/$(VBOX_VERSION_STRING_RAW)/VBoxGuestAdditions_$(VBOX_VERSION_STRING_RAW).iso -O $@</source>
</li>
<li>
По умолчанию собранный VB получает суффикс «OSE» в номере версии («5.1.4_OSE»). Если вас это не устраивает, можно поменять суффикс в файле <code>Config.kmk</code> в строке 1291, заменив код
<source> VBOX_BUILD_PUBLISHER = _OSE</source>
на:
<source> VBOX_BUILD_PUBLISHER =</source>
или на любую другую строку, которая вам подходит. Теоретически, этот параметр должен переопределяться локальным конфигом (см. следующий пункт), но что-то где-то оказалось не учтено, и для корректной сборки приходится менять именно здесь.
</li>
<li>
Если VB собирается с подписыванием, то для большинства исполняемых файлов выставляется флаг принудительной проверки подписи (опция компоновщика <code>/IntegrityCheck</code>). Если у вас полноценный сертификат, это не проблема. Если нет — VB просто откажется запускаться после установки (даже в тестовом режиме). Я модифицировал файл <code>Config.kmk</code> таким образом, чтобы флаг добавлялся только при использовании полноценного сертификата (сертификат считается полноценным, если в файле <code>LocalConfig.kmk</code> задан кросс-сертификат; см. ниже). Набор исправлений заключается в следующем.
<ul>
<li>Вставить блок определения переменной <code>VBOX_INTEGRITY_CHECK</code>, которая будет использоваться вместо фиксированной опции. Я добавил этот блок кода перед строкой «<code>define VBOX_RE_SIGN_DLL_INTERNAL_FN</code>» (номер строки 3278):
<source>if defined(VBOX_SIGNING_MODE) && defined(VBOX_CROSS_CERTIFICATE_FILE)
	VBOX_INTEGRITY_CHECK := /IntegrityCheck
else
	VBOX_INTEGRITY_CHECK := /IntegrityCheck:NO
endif</source>
</li>
<li>Чуть ниже, в строке 3294 (номер строки дан с учётом предыдущей вставки) будет команда:
<source>	$(VBOX_VCC_EDITBIN) /LargeAddressAware /DynamicBase /NxCompat /Release /IntegrityCheck \
		/Version:$(VBOX_VERSION_MAJOR)0$(VBOX_VERSION_MINOR).$(VBOX_VERSION_BUILD) \
		"$@"</source>
Замените здесь <code>/IntegrityCheck</code> на <code>$(VBOX_INTEGRITY_CHECK)</code>.
</li>
<li>Теперь нужно найти все вхождения следующего вида:
<source>ifdef VBOX_SIGNING_MODE
 TEMPLATE_XXXXXX_LDFLAGS          += -IntegrityCheck
endif</source>
или
<source>if defined(VBOX_SIGNING_MODE) && defined(VBOX_WITH_HARDENING)
 TEMPLATE_XXXXXX_LDFLAGS          += -IntegrityCheck
endif</source>
где вместо «<code>XXXXXX</code>» могут быть различные имена компонентов. В VB 5.1.4 таких вхождений — 6 штук, по три каждого вида (номера строк с учётом вышеприведённой вставки: 3714, 3853, 3960, 4300, 5069, 5586). Здесь нужно добавить условие, что переменная кросс-сертификата определена. В итоге первая строчка должна выглядеть, соответственно, как
<source>if defined(VBOX_SIGNING_MODE) && defined(VBOX_CROSS_CERTIFICATE_FILE)</source>
или
<source>if defined(VBOX_SIGNING_MODE) && defined(VBOX_CROSS_CERTIFICATE_FILE) && defined(VBOX_WITH_HARDENING)</source>
</li>
</ul>
</li>
<li>
Ну и, наконец, создаём в корне рабочего каталога файл с именем <code>LocalConfig.kmk</code>, в который прописываем следующее содержимое:
<source>VBOX_WITH_HARDENING :=
SDK_VBOX_OPENSSL-x86_INCS := C:\Programs\OpenSSL\x32\include
SDK_VBOX_OPENSSL-x86_LIBS := C:\Programs\OpenSSL\x32\lib\ssleay32.lib C:\Programs\OpenSSL\x32\lib\libeay32.lib
SDK_VBOX_LIBCURL-x86_INCS := C:\Programs\curl\x32\include
SDK_VBOX_LIBCURL-x86_LIBS := C:\Programs\curl\x32\libcurl.lib
SDK_VBOX_LIBCURL-x86_LIBS.x86 := C:\Programs\curl\x32\libcurl.lib
# 8.3 path for C:\Program Files (x86)\WiX Toolset v3.10\bin
VBOX_PATH_WIX := C:\PROGRA~2\WIXTOO~1.10\bin
VBOX_GSOAP_INSTALLED := 1
VBOX_PATH_GSOAP := C:\Programs\gSOAP
VBOX_WITH_COMBINED_PACKAGE := 1
VBOX_WITH_QT_PAYLOAD := 1
VBOX_WITH_QTGUI_V5 := 1
VBOX_SIGNING_MODE := release
VBOX_CERTIFICATE_SUBJECT_NAME := Roga and Kopyta Ltd
VBOX_CERTIFICATE_FINGERPRINT := XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX
VBOX_CERTIFICATE_SHA2_SUBJECT_NAME := Roga and Kopyta Ltd
VBOX_CERTIFICATE_SHA2_FINGERPRINT := XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX XX
VBOX_TSA_URL := http://timestamp.digicert.com
VBOX_TSA_SHA2_URL := http://timestamp.digicert.com
VBOX_TSA_URL_ARGS := /tr $(VBOX_TSA_URL) /td sha1
VBOX_TSA_SHA2_URL_ARGS := /tr "$(VBOX_TSA_SHA2_URL)" /td sha256
VBOX_CROSS_CERTIFICATE_FILE :=
VBOX_CROSS_CERTIFICATE_FILE_ARGS :=
VBOX_CROSS_CERTIFICATE_SHA2_FILE :=
VBOX_CROSS_CERTIFICATE_SHA2_FILE_ARGS :=
VBOX_PATH_SIGN_TOOLS := C:\Programs\DevKits\8.1\bin\x64
VBOX_PATH_SELFSIGN := C:\WinDDK\7600.16385.1\bin\selfsign
VBOX_PATH_WISUMINFO := "C:\Program Files\Microsoft SDKs\Windows\v7.1\Samples\sysmgmt\msi\scripts\WiSumInf.vbs"
VBOX_WITH_DOCS := 1
VBOX_WITH_DOCS_CHM := 1
VBOX_WITH_DOCS_PACKING := 1
VBOX_HAVE_XMLLINT := C:\Programs\xmllint\bin\xmllint.exe
VBOX_PATH_DOCBOOK_DTD := http://www.oasis-open.org/docbook/xml/4.4/
VBOX_PATH_HTML_HELP_WORKSHOP := "C:\Program Files (x86)\HTML Help Workshop"
VBOX_PDFLATEX := C:\Programs\MiKTeX\miktex\bin\pdflatex.exe
VBOX_PDFLATEX_CMD := $(VBOX_PDFLATEX) -halt-on-error -interaction batchmode
TOOL_WGET_FETCH := C:\Programs\wget\bin\wget.exe
VBOX_INSTALLER_LANGUAGES := en_US
VBOX_WITH_TESTCASES :=
VBOX_WITH_VALIDATIONKIT :=
VBOX_WITH_VBOX_IMG := 1</source>
В вышеприведённом шаблоне необходимо кое-что подправить:
<ul>
<li>Если для сборки используется Qt4 (в частности, в VB 5.0.x), то вместо переменных <code>VBOX_WITH_QT_PAYLOAD</code> и <code>VBOX_WITH_QTGUI_V5</code> надо задать:
<source>VBOX_WITH_QT4_PAYLOAD := 1</source>
</li>
<li>В переменных <code>VBOX_CERTIFICATE_SUBJECT_NAME</code> и <code>VBOX_CERTIFICATE_SHA2_SUBJECT_NAME</code> потребуется указать имена используемых вами сертификатов для подписи SHA-1 и SHA-256, соответственно.</li>
<li>В переменных <code>VBOX_CERTIFICATE_FINGERPRINT</code> и <code>VBOX_CERTIFICATE_SHA2_FINGERPRINT</code> пропишите цифровые отпечатки, которые были скопированы ранее из консоли управления сертификатами.</li>
<li>Если у вас не самоподписанный сертификат, а покупной, то удалите строчки с переменными <code>VBOX_CROSS_CERTIFICATE_FILE_ARGS</code> и <code>VBOX_CROSS_CERTIFICATE_SHA2_FILE_ARGS</code>, а в переменных <code>VBOX_CROSS_CERTIFICATE_FILE</code> и <code>VBOX_CROSS_CERTIFICATE_SHA2_FILE</code> (без «<code>_ARGS</code>») задайте полный путь к файлу кросс-сертификата (без него драйверы не будут считаться подписанными). Его можно найти на сайте компании, выпустившей сертификат, или <a href="https://msdn.microsoft.com/en-us/library/windows/hardware/dn170454(v=vs.85).aspx">у Microsoft</a>.</li>
<li>Для более тонкой настройки подписывания имеется множество других переменных, с помощью которых можно задать хранилище, адрес сервера для наложения временно́й метки или вообще задать произвольный дополнительный набор аргументов для утилиты <code>signtool</code>. В файле <code>Config.kmk</code> под комментарием «Code Signing» (начиная со строки 2923) можно посмотреть, какие там переменные определяются и как они используются.</li>
<li>Если вы устанавливали какие-то из программ в каталоги, отличающиеся от моих, нужно поправить пути в соответствующих переменных. Обратите внимание, что если путь установки WiX содержит пробелы, то необходимо преобразовать его в короткий. Обязательно проверьте, чему он равен на вашей системе (даже для одинаковых длинных имён он может оказаться различным). Для этого можно воспользоваться командой <code>dir /x</code>. Трюк со взятием в кавычки здесь, увы, не работает.</li>
</ul>
Остальные переменные используются в основном для выбора собираемых компонентов. Ну и главная строка, ради которой всё и затевалось, идёт самой первой: отключаем hardening.<br/>
</li>
</ol>
<br/>

<anchor>build-vb</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Собираем VirtualBox</h4><br/>
Ну вот, теперь, наконец, можно и приступать к сборке собственно VirtualBox. Если вы любите параллельную сборку, то придётся от этой привычки временно отказаться (или собирать в двух копиях дерева исходных кодов): здесь используется общий файл конфигурации, который нужно перегенерировать перед началом сборки. И если во время 64-битной компиляции в нём неожиданно окажутся пути к 32-битным библиотекам, компилятору это очень не понравится.<br/>
<ol>
<li>
Начинаем со сборки 64-битной версии. Открываем консоль, выполняем команды:
<source lang=".bat">cd /d C:\Devel\VirtualBox-src
"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7
COLOR 07
set BUILD_TARGET_ARCH=amd64
cscript configure.vbs --with-DDK=C:\WinDDK\7600.16385.1 --with-MinGW-w64=C:\Programs\mingw64 --with-MinGW32=C:\Programs\mingw32 --with-libSDL=C:\Programs\SDL\x64 --with-openssl=C:\Programs\OpenSSL\x64 --with-libcurl=C:\Programs\curl\x64 --with-Qt5=C:\Programs\Qt\5.6.1-x64 --with-python=C:\Programs\Python
env.bat
kmk
kmk C:/Devel/VirtualBox-src/out/win.x86/release/obj/Installer/VirtualBox-5.1.4_OSE-r110228-MultiArch_amd64.msi</source>
Для сборки VB 5.0.x, соответственно, нужно вместо <code>--with-Qt5</code> указать флаг <code>--with-Qt4=C:\Programs\Qt\4.8.7-x64</code><br/>
Скрипт <code>configure.vbs</code> проверяет окружение и создаёт файлы конфигурации (<code>AutoConfig.kmk</code> и <code>env.bat</code>). Первый запуск <code>kmk</code> выполняет сборку бинарных компонентов и помещает их в каталог <code>out\win.amd64\bin\</code>. Последняя команда собирает из этих компонентов промежуточный MSI-архив. Важные моменты:
<ul>
<li>Слэши в последней команде должны быть обязательно прямыми. С обратными <code>kmk</code> не найдёт сборочные правила.</li>
<li>Хоть мы собираем 64-битную версию, архив располагается в подкаталоге <code>out\win.x86\…</code>, потому что финальная сборка будет производиться из 32-битного окружения.</li>
<li>Если вы меняли суффикс версии, то «_OSE» в имени MSI-файла необходимо поправить на то, что вы задали в переменной <code>VBOX_BUILD_PUBLISHER</code>.</li>
<li>Ревизию в имени MSI-файла (108956) можно найти в файле <code>Config.kmk</code> в переменной <code>VBOX_SVN_REV_FALLBACK</code> (строка 6548).</li>
</ul>
</li>
<li>
Теперь собираем 32-битную версию и пакуем весь комплект в единый инсталлятор. Открываем новую консоль, выполняем команды:
<source lang=".bat">cd /d C:\Devel\VirtualBox-src
"C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7
COLOR 07
set BUILD_TARGET_ARCH=x86
cscript configure.vbs --with-DDK=C:\WinDDK\7600.16385.1 --with-MinGW-w64=C:\Programs\mingw64 --with-MinGW32=C:\Programs\mingw32 --with-libSDL=C:\Programs\SDL\x32 --with-openssl=C:\Programs\OpenSSL\x32 --with-libcurl=C:\Programs\curl\x32 --with-Qt5=C:\Programs\Qt\5.6.1-x32 --with-python=C:\Programs\Python
env.bat
kmk
kmk C:/Devel/VirtualBox-src/out/win.x86/release/bin/VirtualBox-5.1.4_OSE-r110228-MultiArch.exe</source>
Аналогично, суффикс «_OSE» в имени итогового файла надо поменять на свой, а при сборке VB 5.0.x — использовать Qt4 вместо Qt5.
</li>
</ol>
<br/>
Если ни я, ни вы ничего не перепутали, то после всех этих перипетий у вас должен получиться инсталлятор VirtualBox, отличающийся от Oracle-версии только значком исполняемого файла, картинкой в диалоге «О программе» и, конечно же, отключённым hardening'ом. При желании значок и картинку тоже можно поменять, но это тема отдельного разговора.<br/>
<br/>
Для удобства я свёл запуск этих двух цепочек команд в единый файл. Если вам регулярно нужно пересобирать пакет, удобнее пользоваться им.
<spoiler title="Единый батник">
<source lang=".bat">@echo off

cd /d %~dp0

for /f "tokens=3" %%i in ('findstr /B /C:"VBOX_VERSION_MAJOR = " Config.kmk') do SET VBOX_VER_MJ=%%i
for /f "tokens=3" %%i in ('findstr /B /C:"VBOX_VERSION_MINOR = " Config.kmk') do SET VBOX_VER_MN=%%i
for /f "tokens=3" %%i in ('findstr /B /C:"VBOX_VERSION_BUILD = " Config.kmk') do SET VBOX_VER_BLD=%%i
for /f "tokens=6" %%i in ('findstr /C:"$Rev: " Config.kmk') do SET VBOX_REV=%%i
for /f "tokens=3" %%i in ('findstr /B /C:"VBOX_BUILD_PUBLISHER = " Config.kmk') do SET VBOX_VER_PUB=%%i

set VERSION=%VBOX_VER_MJ%.%VBOX_VER_MN%.%VBOX_VER_BLD%%VBOX_VER_PUB%-r%VBOX_REV%
set VBOX_VER_MJ=
set VBOX_VER_MN=
set VBOX_VER_BLD=
set VBOX_VER_PUB=

del /q build-tmp.cmd 2>nul

echo.
echo ### %VERSION%: BUILDING x64 VERSION ###
echo.

echo @echo off>> build-tmp.cmd
echo call "C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x64 /win7>> build-tmp.cmd
echo color 07>> build-tmp.cmd
echo set BUILD_TARGET_ARCH=amd64>> build-tmp.cmd
echo cscript configure.vbs --with-DDK=C:\WinDDK\7600.16385.1 --with-MinGW-w64=C:\Programs\mingw64 --with-MinGW32=C:\Programs\mingw32 --with-libSDL=C:\Programs\SDL\x64 --with-openssl=C:\Programs\OpenSSL\x64 --with-libcurl=C:\Programs\curl\x64 --with-Qt5=C:\Programs\Qt\5.6.1-x64 --with-python=C:\Programs\Python>> build-tmp.cmd
echo call env.bat>> build-tmp.cmd
echo kmk>> build-tmp.cmd
echo if ERRORLEVEL 1 exit /b ^1>> build-tmp.cmd
echo kmk C:/Devel/VirtualBox-src/out/win.x86/release/obj/Installer/VirtualBox-%VERSION%-MultiArch_amd64.msi>> build-tmp.cmd
echo if ERRORLEVEL 1 exit /b ^1>> build-tmp.cmd

cmd /c build-tmp.cmd
if ERRORLEVEL 1 exit /b 1

del /q build-tmp.cmd 2>nul

echo.
echo ### %VERSION%: BUILDING x32 VERSION ###
echo.

echo @echo off>> build-tmp.cmd
echo call "C:\Program Files\Microsoft SDKs\Windows\v7.1\Bin\SetEnv.Cmd" /Release /x86 /win7>> build-tmp.cmd
echo color 07>> build-tmp.cmd
echo set BUILD_TARGET_ARCH=x86>> build-tmp.cmd
echo cscript configure.vbs --with-DDK=C:\WinDDK\7600.16385.1 --with-MinGW-w64=C:\Programs\mingw64 --with-MinGW32=C:\Programs\mingw32 --with-libSDL=C:\Programs\SDL\x32 --with-openssl=C:\Programs\OpenSSL\x32 --with-libcurl=C:\Programs\curl\x32 --with-Qt5=C:\Programs\Qt\5.6.1-x32 --with-python=C:\Programs\Python>> build-tmp.cmd
echo call env.bat>> build-tmp.cmd
echo kmk>> build-tmp.cmd
echo if ERRORLEVEL 1 exit /b ^1>> build-tmp.cmd
echo kmk C:/Devel/VirtualBox-src/out/win.x86/release/bin/VirtualBox-%VERSION%-MultiArch.exe>> build-tmp.cmd
echo if ERRORLEVEL 1 exit /b ^1>> build-tmp.cmd

cmd /c build-tmp.cmd
if ERRORLEVEL 1 exit /b 1

del /q build-tmp.cmd 2>nul

echo.
echo ### BUILD COMPLETE ###
echo.</source>
</spoiler>
<br/>
Как неожиданно обнаружилось после выхода статьи, самоподписанный дистрибутив VB отказывается устанавливаться на современные системы (Windows 8/10), сообщая о невалидной подписи драйверов. Причём это происходит даже в тестовом режиме, где валидность подписи не должна играть никакой роли. Чтобы обойти эту проблему, необходимо добавить использовавшиеся сертификаты в корневое хранилище:
<ol>
<li>Откройте свойства скачанного файла дистрибутива: правый щелчок &rarr; Properties, перейдите на вкладку Digital Signatures. Там будут две подписи от «Roga and Kopyta Ltd»: sha1 и sha256. Выделяем первую, жмём Details.</li>
<li>В открывшемся диалоге жмём кнопку View Certificate.</li>
<li>В новом диалоге жмём Install Certificate.</li>
<li>Выбираем для установки Local Machine, Next. Подтверждаем UAC-запрос. Отмечаем пункт "Place all certificates in the following store", нажимаем Browse и выбираем хранилище "Trusted Root Certification Authorities". Next, Finish. Сертификат установлен.</li>
<li>Закрываем все диалоги, кроме самого первого, выделяем подпись sha256, повторям для неё шаги 3–5.</li>
<li>Закрываем все диалоги, запускаем установку.</li>
</ol>
<br/>
<anchor>afterword</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Послесловие</h4>
<br/>
Размер статьи оказался неожиданностью для меня самого. Когда я начинал её писать, то намеревался подробно рассказывать, почему на каждом этапе было выбрано то или иное решение, какие конкретно ошибки выскакивают, если не применить очередную правку, и какие могут быть альтернативные подходы к решению этих ошибок. Но постепенно понял, что если бы я всё это описывал, статья получилась бы и вовсе неприподъёмной. Поэтому прошу прощения за встречающийся кое-где стиль «делай так, а почему — не скажу». Сам недолюбливаю такие инструкции, но тут не видел иного выхода. Впрочем, в отдельных местах я всё-таки постарался хотя бы вкратце пояснить суть происходящего.<br/>
<br/>
Огромное количество аспектов сборочной системы VB осталось за кадром: как из-за нежелания раздувать текст, так и по причине моей лени, когда, найдя какой-то обходной путь для очередной проблемы, я не лез в глубины системы сборки, а поскорее переходил к следующему этапу. В конце концов, моей главной задачей было не найти оптимальный путь, а собрать, наконец, свой вариант актуального VirtualBox'а: сидеть на 4.3.12 уже поднадоело, но я не мог обновлять один из своих основных рабочих инструментов на нечто, что в любой момент может просто отказаться работать на неопределённый срок.<br/>
<br/>
Надеюсь всё же, что, несмотря на недостатки, эта статья окажется кому-нибудь полезной. Для тех, кому лень поднимать всё вышеописанное нагромождение программ, но интересно расковырять получающийся в итоге дистрибутив, я выложил инсталляторы на Яндекс-диск: <a href="https://yadi.sk/d/sSYytnVBtiZai">5.1.2</a>, <a href="https://yadi.sk/d/D_tc3LP2tiZan">5.0.26</a>. Все драйверы в них (да и остальные файлы) подписаны недоверенным сертификатом, так что в 64-битной Windows этот вариант VB заработает только в тестовом режиме. Если имеются вопросы, пожелания, предложения — велкам в комментарии или в личку. И да пребудет с вами Open Source!<br/>
<br/>
<anchor>history</anchor><h4><img src="https://habrastorage.org/getpro/geektimes/post_images/9f8/505/49b/9f850549b13e79dc47d23f5f9e994379.png"/> Дополнения</h4><br/>
<h5>• Обновление статьи от 24.05.2016</h5>
<ol>
<li>Внесены уточнения с учётом изменений в VB 5.0.20, в частности, двойное подписывание SHA-1/SHA-256.</li>
<li>Добавлено отключение флага принудительной проверки подписей, если собирается самоподписанный дистрибутив.</li>
<li>Добавлена инструкция по обходу ошибки установки самоподписанного дистрибутива.</li>
<li>Обновлены версии используемых библиотек.</li>
<li>Для ускорения сборки отключены некоторые неиспользуемые компоненты.</li>
<li>Исправлены мелкие недочёты.</li>
</ol>
<br/>
<h5>• Обновление статьи от 29.07.2016</h5>
<ol>
<li>Внесены уточнения с учётом изменений в VB 5.1.2, в частности, переход на Qt5. Отличия от процедуры сборки для 5.0.x оставлены в виде уточнений.</li>
<li>Обновлены версии используемых библиотек.</li>
<li>В итоговый сборочный скрипт добавлена проверка на корректность завершения каждой стадии.</li>
<li>Исправлены мелкие недочёты.</li>
</ol>
<h5>• Обновление статьи от 6.09.2016</h5>
<ol>
<li>Внесены уточнения с учётом изменений в VB 5.1.4.</li>
<li>Обновлены версии используемых библиотек.</li>
<li>Добавлено использование NASM для сборки OpenSSL.</li>
<li>cURL теперь собирается с поддержкой OpenSSL, потому что иначе не работают функции проверки обновлений и загрузки пакета расширений.</li>
<li>Доработан комбинированный скрипт сборки, чтобы версия определялась автоматически.</li>
<li>Различные мелкие правки.</li>
</ol>
